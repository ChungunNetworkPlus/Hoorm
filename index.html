<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/favicon" />

    <title>Hoorm</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
      @font-face {
        font-family: 'GmarketSansMedium';
        src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff')
          format('woff');
      }
      body {
        font-family: 'GmarketSansMedium', sans-serif;
        margin: 0;
        padding: 0;
        background: #fff;
        color: #000;
      }
      .all {
        background-color: rgb(198, 228, 255);
        margin: 0 100px 100px;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 50vh;
        border-radius: 12px;
      }
      .title {
        font-size: 30px;
        font-weight: 700;
        padding: 10px;
        margin-right: 30px;
      }
      .content {
        font-size: 16px;
        padding: 20px;
      }
      .checkbox input[type='radio'] {
        width: 20px;
        height: 20px;
        vertical-align: middle;
        cursor: pointer;
      }
      .checkbox label {
        margin-right: 35px;
        font-size: 18px;
        cursor: pointer;
        user-select: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }
      .logo-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin: 20px;
      }
      .programmer {
        color: rgb(182, 181, 181);
        font-size: 18px;
      }
      .input-gcn,
      .input-name {
        margin-bottom: 12px;
      }
      .input-gcn {
        margin-top: 12px;
      }
      input[type='text'] {
        font-size: 18px;
        padding: 6px 8px;
        width: 150px;
        font-family: 'GmarketSansMedium';
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      button {
        font-size: 16px;
        font-family: 'GmarketSansMedium';
        color: black;
        background-color: aliceblue;
        border: 1px solid;
        border-radius: 2px;
        cursor: pointer;
        padding: 4px 8px;
        margin-top: 6px;
      }
      #input-group {
        display: none;
      }

      #login {
        display: flex;
        gap: 10px;
      }
    </style>
  </head>
  <body>
    <div
      id="g_id_onload"
      data-client_id="968179955551-ihoe25vh1ls7quuomf7epvnltr4f3l64.apps.googleusercontent.com"
      data-callback="handleCredentialResponse"
      data-auto_select="false"
      data-itp_support="true"
    ></div>

    <div class="logo-container">
      <img src="/hoorm" alt="Hoorm 로고" width="150" />
      <div class="programmer">
        made by 44대 생활부장 권효주, 2024 웹진 제작자 윤동현
      </div>
    </div>

    <div id="login">
      <div>필히 학교 계정으로 로그인 하시오!!</div>
      <div
        class="g_id_signin"
        data-type="standard"
        data-shape="pill"
        data-theme="outline"
        data-text="signin_with"
        data-size="large"
        data-logo_alignment="left"
      ></div>
      <p id="userEmail"></p>
      <p id="userName"></p>
    </div>

    <div class="all">
      <div class="title">학번번호와 이름을<br />입력해주세요</div>
      <div class="content">
        <div class="checkbox">
          <label for="checkstudent"
            ><input type="radio" name="identity" id="checkstudent" />학생</label
          >
          <label for="checkcouncil"
            ><input
              type="radio"
              name="identity"
              id="checkcouncil"
            />학생회</label
          >
          <label for="checkteacher"
            ><input
              type="radio"
              name="identity"
              id="checkteacher"
            />선생님</label
          >
        </div>

        <div id="input-group">
          <div class="input-gcn">
            <label id="gcn-label" for="gcninput">학반번호</label><br />
            <input type="text" id="gcninput" autocomplete="off" />
          </div>
          <div class="input-name">
            <label for="nameinput">이름</label><br />
            <input type="text" id="nameinput" autocomplete="off" />
          </div>
          <button id="submit-btn">확인</button>
        </div>
      </div>
    </div>

    <script>
      let myname = '';
      function base64UrlDecodeUtf8(base64Url) {
        // 1. Base64URL → Base64
        let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        while (base64.length % 4) base64 += '=';

        // 2. atob로 디코딩 → Latin1 문자열
        let binary = atob(base64);

        // 3. Latin1 → UTF-8
        let bytes = Uint8Array.from(binary, (c) => c.charCodeAt(0));
        let decoded = new TextDecoder().decode(bytes);

        return decoded;
      }

      function parseJwt(token) {
        let payload = token.split('.')[1];
        return JSON.parse(base64UrlDecodeUtf8(payload));
      }
      function handleCredentialResponse(response) {
        // 1. ID Token (JWT) 받음
        const token = response.credential;

        // 2. 토큰 디코드 (header.payload.signature 중 payload 부분 base64 decode)
        const payload = parseJwt(token);
        console.log(payload);

        // 3. 화면에 사용자 정보 표시
        document.getElementById('userName').textContent = payload.name;
        document.getElementById('userEmail').textContent = payload.email;

        // document.getElementById('userInfo').style.display = 'block';

        if (payload.email.includes('@hcu.hs.kr')) {
          myname = payload.name;
        } else {
          alert('학교 계정으로 로그인하시오');
          location.reload();
        }
      }

      const radios = document.querySelectorAll('input[name="identity"]');
      const inputGroup = document.getElementById('input-group');
      const inputName = document.querySelector('.input-name');
      const gcnLabel = document.getElementById('gcn-label');
      const submitBtn = document.getElementById('submit-btn');

      const gcninput = document.querySelector('#gcninput');
      const nameinput = document.querySelector('#nameinput');

      const checkstudent = document.querySelector('#checkstudent');

      inputGroup.style.display = 'none';

      radios.forEach((radio) => {
        radio.addEventListener('change', () => {
          inputGroup.style.display = 'block';

          if (document.getElementById('checkstudent').checked) {
            inputName.style.display = 'block';
            gcnLabel.textContent = '학반번호';
          } else {
            inputName.style.display = 'none';
            document.getElementById('nameinput').value = '';
            gcnLabel.textContent = '고유코드';
          }
        });
      });

      fetch('/allpeople')
        .then((res) => res.json())
        .then((array) => {
          function checkMatch(gcnInput, nameInput) {
            const result = array.find((obj) => obj.gcn === Number(gcnInput));
            if (!result) return '해당 학반번호를 가진 학생이 없습니다.';
            if (result.name !== nameInput) return '이름이 일치하지 않습니다.';
            return '이름이 일치합니다.';
          }

          submitBtn.addEventListener('click', () => {
            const gcnValue = document.getElementById('gcninput').value.trim();
            const gcnNumber = Number(gcnValue);
            const isStudent = document.getElementById('checkstudent').checked;
            const isCouncil = document.getElementById('checkcouncil').checked;
            const isTeacher = document.getElementById('checkteacher').checked;

            if (!gcnValue) {
              return alert('학반번호 또는 고유코드를 입력해주세요.');
            }

            if (isStudent) {
              if (gcnNumber <= 10101 || gcnNumber >= 30731) {
                return alert('학번이 옳지 못한 입력입니다.');
              }
              const nameValue = document
                .getElementById('nameinput')
                .value.trim();
              if (!nameValue) return alert('이름을 입력해주세요.');
              if (nameValue !== myname) {
                alert('너 누구냐!');
                location.reload();
                return;
              }
              const result = checkMatch(gcnValue, nameValue);
              alert(result);
              if (result === '이름이 일치합니다.') {
                window.location.href = `/check?gcn=${gcninput.value}&name=${nameinput.value}`;
              }
            } else if (isCouncil) {
              window.location.href = `/dorm?pw=${gcnValue}`;
            } else if (isTeacher) {
              window.location.href = `/teacher?pw=${gcnValue}`;
            } else {
              alert('신분을 선택해주세요.');
            }
          });
          checkstudent.click();
        });
    </script>
  </body>
</html>
